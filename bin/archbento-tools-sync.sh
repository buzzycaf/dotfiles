#!/usr/bin/env bash
set -euo pipefail

# Archbento Tools Framework sync script
# Renders tools.env into:
#  1) Hyprland variables: ~/.config/hypr/tools.conf
#  2) systemd user environment: ~/.config/environment.d/99-archbento.conf
#  3) zsh exports: ~/.config/zsh/archbento-tools.zsh

die() { echo "archbento-tools-sync: $*" >&2; exit 1; }

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd -- "$SCRIPT_DIR/.." && pwd)"

# Prefer repo tools.env when script is run from repo (bin/...)
TOOLS_ENV_REPO="$REPO_DIR/tools.env"
# Fallback for installed systems (install.sh should copy tools.env here)
TOOLS_ENV_INSTALLED="$HOME/.local/state/archbento/tools.env"

if [[ -f "$TOOLS_ENV_REPO" ]]; then
  TOOLS_ENV="$TOOLS_ENV_REPO"
elif [[ -f "$TOOLS_ENV_INSTALLED" ]]; then
  TOOLS_ENV="$TOOLS_ENV_INSTALLED"
else
  die "tools.env not found. Expected either:
  - $TOOLS_ENV_REPO
  - $TOOLS_ENV_INSTALLED"
fi

HYPR_OUT="$HOME/.config/hypr/tools.conf"
SYSTEMD_OUT="$HOME/.config/environment.d/99-archbento.conf"
ZSH_OUT="$HOME/.config/zsh/archbento-tools.zsh"

mkdir -p "$(dirname "$HYPR_OUT")" "$(dirname "$SYSTEMD_OUT")" "$(dirname "$ZSH_OUT")"

# ----- parse tools.env -----
# Ignore blank lines and comments. Parse KEY=VALUE.
# Keys must be A-Z0-9_. Values are taken literally (trimmed).
declare -A KV
declare -a ORDER

while IFS= read -r line || [[ -n "$line" ]]; do
  # trim leading/trailing whitespace
  line="${line#"${line%%[![:space:]]*}"}"
  line="${line%"${line##*[![:space:]]}"}"

  [[ -z "$line" ]] && continue
  [[ "${line:0:1}" == "#" ]] && continue

  [[ "$line" == *"="* ]] || die "Invalid line (expected KEY=VALUE): $line"

  key="${line%%=*}"
  value="${line#*=}"

  # trim key/value whitespace
  key="${key#"${key%%[![:space:]]*}"}"
  key="${key%"${key##*[![:space:]]}"}"
  value="${value#"${value%%[![:space:]]*}"}"
  value="${value%"${value##*[![:space:]]}"}"

  [[ -n "$key" ]] || die "Empty key in line: $line"
  [[ "$key" =~ ^[A-Z0-9_]+$ ]] || die "Invalid key '$key' (use A-Z0-9_ only)"

  # Avoid clobbering POSIX TERM; map TERM -> TERMINAL for outputs (recommended fix is in tools.env)
  if [[ "$key" == "TERM" ]]; then
    echo "archbento-tools-sync: WARNING: tools.env uses TERM=...; prefer TERMINAL=... to avoid conflicts." >&2
    key="TERMINAL"
  fi

  if [[ -z "${KV[$key]+x}" ]]; then
    ORDER+=("$key")
  fi
  KV["$key"]="$value"
done < "$TOOLS_ENV"

# ----- write Hyprland vars (tools.conf) -----
tmp_hypr="$(mktemp)"
{
  echo "# ====================================================================="
  echo "# Archbento Tools Framework — Hyprland variables"
  echo "# AUTOGENERATED from tools.env — DO NOT EDIT"
  echo "# ====================================================================="
  echo
  for key in "${ORDER[@]}"; do
    val="${KV[$key]:-}"
    [[ -n "$val" ]] || continue
    echo "\$$key = $val"
  done
} > "$tmp_hypr"
mv -f "$tmp_hypr" "$HYPR_OUT"

# ----- write systemd environment.d -----
tmp_sysd="$(mktemp)"
{
  echo "# Archbento Tools Framework — systemd user environment"
  echo "# AUTOGENERATED from tools.env — DO NOT EDIT"
  echo
  for key in "${ORDER[@]}"; do
    val="${KV[$key]:-}"
    [[ -n "$val" ]] || continue
    echo "$key=$val"
  done
} > "$tmp_sysd"
mv -f "$tmp_sysd" "$SYSTEMD_OUT"

# ----- write zsh exports -----
tmp_zsh="$(mktemp)"
{
  echo "# Archbento Tools Framework — zsh exports"
  echo "# AUTOGENERATED from tools.env — DO NOT EDIT"
  echo
  for key in "${ORDER[@]}"; do
    val="${KV[$key]:-}"
    [[ -n "$val" ]] || continue
    printf 'export %s=%q\n' "$key" "$val"
  done
} > "$tmp_zsh"
mv -f "$tmp_zsh" "$ZSH_OUT"

echo "archbento-tools-sync: wrote:"
echo "  - $HYPR_OUT"
echo "  - $SYSTEMD_OUT"
echo "  - $ZSH_OUT"
